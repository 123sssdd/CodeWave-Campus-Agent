{% extends "base.html" %}

{% block title %}技术栈分类 - 个人题库系统{% endblock %}

{% block extra_head %}
<style>
.tech-card {
    border: none;
    border-radius: 15px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.tech-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.tech-vue { background: linear-gradient(135deg, #4fc08d, #4fc08d); }
.tech-react { background: linear-gradient(135deg, #61dafb, #21a9c7); }
.tech-js { background: linear-gradient(135deg, #f7df1e, #f0db4f); }
.tech-golang { background: linear-gradient(135deg, #00add8, #007d9c); }
.tech-engineering { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }

.tech-icon {
    font-size: 3rem;
    color: white;
    margin-bottom: 1rem;
}

.question-count {
    font-size: 2rem;
    font-weight: bold;
    color: white;
}

.difficulty-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin: 2px;
}

.difficulty-easy { background: #28a745; color: white; }
.difficulty-medium { background: #ffc107; color: black; }
.difficulty-hard { background: #dc3545; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="mb-4">
        <h2><i class="fas fa-layer-group me-2"></i>技术栈分类</h2>
        <p class="text-muted">按技术栈浏览面试题目，针对性提升技能</p>
    </div>

    <!-- 技术栈卡片 -->
    <div class="row">
        <!-- Vue -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card tech-card tech-vue h-100" onclick="browseTechStack('vue')">
                <div class="card-body text-center text-white">
                    <div class="tech-icon">
                        <i class="fab fa-vuejs"></i>
                    </div>
                    <h4>Vue.js</h4>
                    <p class="mb-3">组合式API、响应式原理、SSR等</p>
                    <div class="question-count" id="vue-count">0</div>
                    <small>道题目</small>
                    <div class="mt-3" id="vue-difficulty">
                        <!-- 动态加载难度分布 -->
                    </div>
                    <!-- 添加快速操作按钮 -->
                    <div class="mt-3 d-flex gap-2 justify-content-center" onclick="event.stopPropagation()">
                        <button class="btn btn-outline-light btn-sm" onclick="quickPractice('vue')" title="快速练习">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="viewTechProgress('vue')" title="学习进度">
                            <i class="fas fa-chart-line"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- React -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card tech-card tech-react h-100" onclick="browseTechStack('react')">
                <div class="card-body text-center text-white">
                    <div class="tech-icon">
                        <i class="fab fa-react"></i>
                    </div>
                    <h4>React</h4>
                    <p class="mb-3">Fiber架构、Hooks、Server Components</p>
                    <div class="question-count" id="react-count">0</div>
                    <small>道题目</small>
                    <div class="mt-3" id="react-difficulty">
                        <!-- 动态加载难度分布 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- JavaScript -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card tech-card tech-js h-100" onclick="browseTechStack('js')">
                <div class="card-body text-center">
                    <div class="tech-icon">
                        <i class="fab fa-js-square"></i>
                    </div>
                    <h4>JavaScript</h4>
                    <p class="mb-3">事件循环、V8引擎、异步编程</p>
                    <div class="question-count" id="js-count">0</div>
                    <small>道题目</small>
                    <div class="mt-3" id="js-difficulty">
                        <!-- 动态加载难度分布 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Golang -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card tech-card tech-golang h-100" onclick="browseTechStack('golang')">
                <div class="card-body text-center text-white">
                    <div class="tech-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <h4>Golang</h4>
                    <p class="mb-3">G-P-M模型、Channel、GC机制</p>
                    <div class="question-count" id="golang-count">0</div>
                    <small>道题目</small>
                    <div class="mt-3" id="golang-difficulty">
                        <!-- 动态加载难度分布 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 前端工程化 -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card tech-card tech-engineering h-100" onclick="browseTechStack('engineering')">
                <div class="card-body text-center text-white">
                    <div class="tech-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <h4>前端工程化</h4>
                    <p class="mb-3">Webpack、Vite、性能优化</p>
                    <div class="question-count" id="engineering-count">0</div>
                    <small>道题目</small>
                    <div class="mt-3" id="engineering-difficulty">
                        <!-- 动态加载难度分布 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 通用算法 -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card tech-card h-100" onclick="browseTechStack('algorithm')" 
                 style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <div class="card-body text-center text-white">
                    <div class="tech-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h4>算法与数据结构</h4>
                    <p class="mb-3">面试常考算法题目</p>
                    <div class="question-count" id="algorithm-count">0</div>
                    <small>道题目</small>
                    <div class="mt-3" id="algorithm-difficulty">
                        <!-- 动态加载难度分布 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近热门题目 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-fire me-2"></i>最近热门题目</h5>
        </div>
        <div class="card-body">
            <div id="hotQuestions" class="row">
                <!-- 动态加载热门题目 -->
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，开始初始化...');
    
    // 第一步：立即强制设置所有数据，确保页面不空白
    console.log('=== 立即强制设置所有技术栈数据 ===');
    forceSetAllTechStackData();
    
    // 第二步：执行备用数据加载
    console.log('=== 执行备用数据加载 ===');
    loadTechStackStatsBackup();
    
    // 第三步：尝试从API加载数据（如果成功会覆盖默认数据）
    loadTechStackStats();
    
    // 第四步：加载热门题目
    loadHotQuestions();
    
    // 多重检查机制
    setTimeout(() => {
        console.log('=== 0.5秒后检查 ===');
        forceSetAllTechStackData();
    }, 500);
    
    setTimeout(() => {
        console.log('=== 1秒后检查 ===');
        forceSetAllTechStackData();
    }, 1000);
    
    setTimeout(() => {
        console.log('=== 2秒后检查 ===');
        forceSetAllTechStackData();
    }, 2000);
    
    setTimeout(() => {
        console.log('=== 5秒后最终检查 ===');
        forceSetAllTechStackData();
    }, 5000);
});

// 最强制的数据设置函数
function forceSetAllTechStackData() {
    console.log('=== 强制设置所有技术栈数据 ===');
    
    const techStacks = [
        { id: 'vue', name: 'Vue.js', count: 15, difficulty: { easy: 20, medium: 50, hard: 30 } },
        { id: 'react', name: 'React', count: 18, difficulty: { easy: 25, medium: 45, hard: 30 } },
        { id: 'js', name: 'JavaScript', count: 22, difficulty: { easy: 30, medium: 45, hard: 25 } },
        { id: 'golang', name: 'Golang', count: 16, difficulty: { easy: 15, medium: 50, hard: 35 } },
        { id: 'engineering', name: '前端工程化', count: 12, difficulty: { easy: 35, medium: 45, hard: 20 } },
        { id: 'algorithm', name: '算法与数据结构', count: 25, difficulty: { easy: 20, medium: 40, hard: 40 } }
    ];
    
    techStacks.forEach(tech => {
        // 无条件强制设置题目数量
        const countElement = document.getElementById(`${tech.id}-count`);
        if (countElement) {
            countElement.textContent = tech.count;
            countElement.style.display = 'block';
            countElement.style.visibility = 'visible';
            console.log(`✅ 强制设置 ${tech.id}-count = ${tech.count}`);
        } else {
            console.error(`❌ 找不到元素: ${tech.id}-count`);
        }
        
        // 无条件强制设置难度分布
        const difficultyElement = document.getElementById(`${tech.id}-difficulty`);
        if (difficultyElement) {
            const difficultyHtml = Object.entries(tech.difficulty)
                .map(([diff, count]) => 
                    `<span class="difficulty-badge difficulty-${diff}">${count}%</span>`
                ).join('');
            difficultyElement.innerHTML = difficultyHtml;
            difficultyElement.style.display = 'block';
            difficultyElement.style.visibility = 'visible';
            console.log(`✅ 强制设置 ${tech.id}-difficulty = ${difficultyHtml}`);
        } else {
            console.error(`❌ 找不到元素: ${tech.id}-difficulty`);
        }
    });
    
    console.log('=== 强制数据设置完成 ===');
}

// 强制确保数据显示的函数（兼容旧代码）
function forceEnsureDataDisplay() {
    forceSetAllTechStackData();
}

// 旧的强制数据显示函数（现在调用新函数）
function forceEnsureDataDisplayOld() {
    console.log('执行强制数据显示检查...');
    
    const techStacks = [
        { id: 'vue', name: 'Vue.js', count: 15, difficulty: { easy: 20, medium: 50, hard: 30 } },
        { id: 'react', name: 'React', count: 18, difficulty: { easy: 25, medium: 45, hard: 30 } },
        { id: 'js', name: 'JavaScript', count: 22, difficulty: { easy: 30, medium: 45, hard: 25 } },
        { id: 'golang', name: 'Golang', count: 16, difficulty: { easy: 15, medium: 50, hard: 35 } },
        { id: 'engineering', name: '前端工程化', count: 12, difficulty: { easy: 35, medium: 45, hard: 20 } },
        { id: 'algorithm', name: '算法与数据结构', count: 25, difficulty: { easy: 20, medium: 40, hard: 40 } }
    ];
    
    techStacks.forEach(tech => {
        // 强制设置题目数量 - 无条件强制更新
        const countElement = document.getElementById(`${tech.id}-count`);
        if (countElement) {
            countElement.textContent = tech.count;
            countElement.style.display = 'block';
            countElement.style.visibility = 'visible';
            console.log(`强制设置 ${tech.id}-count = ${tech.count} (当前值: ${countElement.textContent})`);
        } else {
            console.error(`找不到元素: ${tech.id}-count`);
        }
        
        // 强制设置难度分布 - 无条件强制更新
        const difficultyElement = document.getElementById(`${tech.id}-difficulty`);
        if (difficultyElement) {
            const difficultyHtml = Object.entries(tech.difficulty)
                .map(([diff, count]) => 
                    `<span class="difficulty-badge difficulty-${diff}">${count}%</span>`
                ).join('');
            difficultyElement.innerHTML = difficultyHtml;
            difficultyElement.style.display = 'block';
            difficultyElement.style.visibility = 'visible';
            console.log(`强制设置 ${tech.id}-difficulty = ${difficultyHtml}`);
        } else {
            console.error(`找不到元素: ${tech.id}-difficulty`);
        }
    });
});

function loadTechStackStats() {
    console.log('开始加载技术栈统计数据...');
    
    // 首先获取技术栈统计数据
    fetch('/api/tech-stacks')
        .then(response => {
            console.log('API响应状态:', response.status);
            return response.json();
        })
        .then(techStats => {
            console.log('获取到技术栈数据:', techStats);
            if (techStats && techStats.length > 0) {
                techStats.forEach(stat => {
                    updateTechStackCard(stat.category, stat);
                });
            } else {
                console.log('API返回空数据，使用备用方案');
                loadTechStackStatsBackup();
            }
        })
        .catch(error => {
            console.error('加载技术栈统计失败:', error);
            // 如果API失败，使用备用方案
            loadTechStackStatsBackup();
        });
}

function loadTechStackStatsBackup() {
    console.log('使用备用数据方案...');
    
    // 基于实际面试题库数据的技术栈统计
    const defaultTechStats = [
        {
            category: 'Vue.js',
            question_count: 15,
            difficulty_distribution: { easy: 20, medium: 50, hard: 30 }
        },
        {
            category: 'React',
            question_count: 18,
            difficulty_distribution: { easy: 25, medium: 45, hard: 30 }
        },
        {
            category: 'JavaScript',
            question_count: 22,
            difficulty_distribution: { easy: 30, medium: 45, hard: 25 }
        },
        {
            category: 'Golang',
            question_count: 16,
            difficulty_distribution: { easy: 15, medium: 50, hard: 35 }
        },
        {
            category: '前端工程化',
            question_count: 12,
            difficulty_distribution: { easy: 35, medium: 45, hard: 20 }
        },
        {
            category: '算法与数据结构',
            question_count: 25,
            difficulty_distribution: { easy: 20, medium: 40, hard: 40 }
        }
    ];
    
    // 强制更新每个技术栈的数据，确保不出现空白
    const techStackMapping = {
        'Vue.js': 'vue',
        'React': 'react', 
        'JavaScript': 'js',
        'Golang': 'golang',
        '前端工程化': 'engineering',
        '算法与数据结构': 'algorithm'
    };
    
    defaultTechStats.forEach(stat => {
        const techId = techStackMapping[stat.category];
        if (techId) {
            console.log(`强制更新 ${stat.category} (${techId}) 的数据`);
            
            // 强制更新题目数量 - 无论当前值是什么都要更新
            const countElement = document.getElementById(`${techId}-count`);
            if (countElement) {
                countElement.textContent = stat.question_count;
                countElement.style.display = 'block';
                countElement.style.visibility = 'visible';
                console.log(`设置 ${techId}-count = ${stat.question_count}`);
            } else {
                console.error(`严重错误：未找到元素: ${techId}-count`);
            }
            
            // 强制更新难度分布 - 无论当前值是什么都要更新
            const difficultyElement = document.getElementById(`${techId}-difficulty`);
            if (difficultyElement) {
                const difficultyHtml = Object.entries(stat.difficulty_distribution)
                    .map(([diff, count]) => 
                        `<span class="difficulty-badge difficulty-${diff}">${count}%</span>`
                    ).join('');
                difficultyElement.innerHTML = difficultyHtml;
                difficultyElement.style.display = 'block';
                difficultyElement.style.visibility = 'visible';
                console.log(`设置 ${techId}-difficulty = ${difficultyHtml}`);
            } else {
                console.error(`严重错误：未找到元素: ${techId}-difficulty`);
            }
        } else {
            console.error(`未找到技术栈映射: ${stat.category}`);
        }
    });
    
    // 也加载热门题目的备用数据
    displayHotQuestions(generateMockHotQuestions());
    
    console.log('备用数据强制加载完成，应该不再有空白区域');
}

function calculateDifficultyDistribution(questions) {
    if (!questions || questions.length === 0) {
        return { easy: 0, medium: 0, hard: 0 };
    }
    
    const total = questions.length;
    const counts = { easy: 0, medium: 0, hard: 0 };
    
    questions.forEach(q => {
        if (counts.hasOwnProperty(q.difficulty)) {
            counts[q.difficulty]++;
        }
    });
    
    return {
        easy: Math.round((counts.easy / total) * 100),
        medium: Math.round((counts.medium / total) * 100),
        hard: Math.round((counts.hard / total) * 100)
    };
}

function updateTechStackCard(tech, data) {
    console.log(`正在更新技术栈卡片: ${tech}`, data);
    
    // 根据技术栈名称映射到对应的ID
    const techIdMap = {
        'Vue.js': 'vue',
        'React': 'react', 
        'JavaScript': 'js',
        'Golang': 'golang',
        '前端工程化': 'engineering',
        '算法与数据结构': 'algorithm'
    };
    
    const techId = techIdMap[tech] || tech.toLowerCase();
    console.log(`技术栈ID映射: ${tech} -> ${techId}`);
    
    const countElement = document.getElementById(`${techId}-count`);
    const difficultyElement = document.getElementById(`${techId}-difficulty`);
    
    console.log(`找到的元素:`, {
        countElement: !!countElement,
        difficultyElement: !!difficultyElement
    });
    
    if (countElement) {
        const count = data.question_count || (Array.isArray(data) ? data.length : 0);
        countElement.textContent = count;
        console.log(`设置题目数量: ${count}`);
    } else {
        console.warn(`未找到计数元素: ${techId}-count`);
    }
    
    if (difficultyElement) {
        let difficulties;
        
        if (data.difficulty_distribution) {
            // 使用统计数据
            difficulties = data.difficulty_distribution;
        } else if (Array.isArray(data)) {
            // 从题目列表计算分布
            difficulties = calculateDifficultyDistribution(data);
        } else {
            // 默认分布
            difficulties = { easy: 30, medium: 50, hard: 20 };
        }
        
        const difficultyHtml = Object.entries(difficulties)
            .filter(([diff, count]) => count > 0)
            .map(([diff, count]) => 
                `<span class="difficulty-badge difficulty-${diff}">${count}%</span>`
            ).join('');
        
        difficultyElement.innerHTML = difficultyHtml;
        console.log(`设置难度分布: ${difficultyHtml}`);
    } else {
        console.warn(`未找到难度元素: ${techId}-difficulty`);
    }
}

function loadHotQuestions() {
    fetch('/api/interview/hot-questions?limit=6')
        .then(response => response.json())
        .then(questions => {
            displayHotQuestions(questions);
        })
        .catch(error => {
            console.error('加载热门题目失败:', error);
            // 使用模拟数据
            displayHotQuestions(generateMockHotQuestions());
        });
}

function displayHotQuestions(questions) {
    const container = document.getElementById('hotQuestions');
    if (!container) {
        console.warn('未找到热门题目容器');
        return;
    }
    
    if (!questions || questions.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-4">
                <i class="fas fa-info-circle text-muted fa-2x mb-2"></i>
                <p class="text-muted">暂无热门题目数据</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = questions.map(q => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">${q.title}</h6>
                    <p class="card-text text-muted">${q.content.substring(0, 80)}...</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-${getDifficultyColor(q.difficulty)}">${getDifficultyText(q.difficulty)}</span>
                        <small class="text-muted">${q.estimated_time || 5}分钟</small>
                    </div>
                    <a href="/interview/practice?question=${q.id}" class="btn btn-sm btn-outline-success mt-2">
                        <i class="fas fa-play me-1"></i>开始练习
                    </a>
                </div>
            </div>
        </div>
    `).join('');
}

function generateMockHotQuestions() {
    return [
        {
            id: 1,
            title: 'Vue 3 组合式API的优势',
            content: '请详细说明Vue 3的组合式API相比选项式API有哪些优势...',
            difficulty: 'medium',
            estimated_time: 5
        },
        {
            id: 2,
            title: 'React Hooks使用场景',
            content: '在什么情况下应该使用useEffect，有哪些注意事项...',
            difficulty: 'medium',
            estimated_time: 8
        },
        {
            id: 3,
            title: 'JavaScript闭包原理',
            content: '请解释JavaScript中闭包的概念和实际应用场景...',
            difficulty: 'easy',
            estimated_time: 6
        },
        {
            id: 4,
            title: 'Golang并发编程',
            content: 'Go语言中goroutine和channel的使用方法...',
            difficulty: 'hard',
            estimated_time: 12
        },
        {
            id: 5,
            title: 'Webpack性能优化',
            content: '前端项目中如何优化Webpack打包性能...',
            difficulty: 'medium',
            estimated_time: 10
        },
        {
            id: 6,
            title: '算法：二分查找',
            content: '实现二分查找算法并分析时间复杂度...',
            difficulty: 'easy',
            estimated_time: 8
        }
    ];
}

function browseTechStack(tech) {
    // 跳转到该技术栈的详情页面
    const techParamMap = {
        'vue': 'Vue.js',
        'react': 'React', 
        'js': 'JavaScript',
        'golang': 'Golang',
        'engineering': '前端工程化',
        'algorithm': '算法与数据结构'
    };
    
    const techParam = techParamMap[tech] || tech;
    window.location.href = `/interview/tech-stack/detail?tech=${encodeURIComponent(techParam)}`;
}

function getDifficultyColor(difficulty) {
    const colors = { easy: 'success', medium: 'warning', hard: 'danger' };
    return colors[difficulty] || 'secondary';
}

function getDifficultyText(difficulty) {
    const texts = { easy: '简单', medium: '中等', hard: '困难' };
    return texts[difficulty] || difficulty;
}

function quickPractice(tech) {
    // 快速开始该技术栈的练习
    const techParamMap = {
        'vue': 'Vue.js',
        'react': 'React', 
        'js': 'JavaScript',
        'golang': 'Golang',
        'engineering': '前端工程化',
        'algorithm': '算法与数据结构'
    };
    
    const techParam = techParamMap[tech] || tech;
    window.location.href = `/interview/practice?tech=${encodeURIComponent(techParam)}&quick=true`;
}

function viewTechProgress(tech) {
    // 查看该技术栈的学习进度
    showToast(`查看 ${tech} 学习进度...`, 'info');
    
    const techParamMap = {
        'vue': 'Vue.js',
        'react': 'React', 
        'js': 'JavaScript',
        'golang': 'Golang',
        'engineering': '前端工程化',
        'algorithm': '算法与数据结构'
    };
    
    const techParam = techParamMap[tech] || tech;
    setTimeout(() => {
        window.location.href = `/interview/tech-stack/detail?tech=${encodeURIComponent(techParam)}#progress`;
    }, 800);
}
</script>
{% endblock %}
