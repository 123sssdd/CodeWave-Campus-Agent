{% extends "base.html" %}

{% block title %}面试准备 - 个人题库系统{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.mode-indicator {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.interview-card {
    border-left: 4px solid #28a745;
    transition: transform 0.3s ease;
}

.interview-card:hover {
    transform: translateY(-2px);
}

.tech-badge {
    background: linear-gradient(135deg, #007bff, #6610f2);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    margin: 2px;
    display: inline-block;
}

.progress-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(#28a745 var(--progress), #e9ecef 0);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 模式指示器 -->
    <div class="mode-indicator">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h3 class="mb-1">
                    <i class="fas fa-briefcase me-2"></i>面试准备中心
                </h3>
                <p class="mb-0">针对技术面试的专业题库，助力求职成功</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/" class="btn btn-outline-light">
                    <i class="fas fa-graduation-cap me-1"></i>切换到学术模式
                </a>
            </div>
        </div>
    </div>
    
    <!-- 面试准备概览 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card interview-card h-100">
                <div class="card-body text-center">
                    <div class="display-6 text-success mb-2">
                        <i class="fas fa-code"></i>
                    </div>
                    <h6>技术栈覆盖</h6>
                    <div id="techStacksInfo">
                        <span class="tech-badge">Vue</span>
                        <span class="tech-badge">React</span>
                        <span class="tech-badge">Golang</span>
                        <span class="tech-badge">JavaScript</span>
                    </div>
                    <small class="text-muted mt-2 d-block">前后端全栈覆盖</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card interview-card h-100">
                <div class="card-body text-center">
                    <div class="display-6 text-primary mb-2">
                        <i class="fas fa-building"></i>
                    </div>
                    <h6>公司真题</h6>
                    <h4 class="text-primary" id="questionCount">加载中...</h4>
                    <small class="text-muted">道面试真题</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card interview-card h-100">
                <div class="card-body text-center">
                    <div class="display-6 text-warning mb-2">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h6>学习进度</h6>
                    <div class="progress-circle" id="progressCircle" style="--progress: 0%;">
                        <span>0%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card interview-card h-100">
                <div class="card-body text-center">
                    <div class="display-6 text-info mb-2">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h6>面试计划</h6>
                    <h4 class="text-info" id="planCount">0</h4>
                    <small class="text-muted">个活跃计划</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 面试计划制定 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-target me-2"></i>制定面试计划
                    </h5>
                </div>
                <div class="card-body">
                    <form id="interviewPlanForm">
                        <div class="mb-3">
                            <label class="form-label">目标岗位</label>
                            <select class="form-select" id="targetPosition" required>
                                <option value="">选择目标岗位</option>
                                <option value="frontend">前端工程师</option>
                                <option value="backend">后端工程师</option>
                                <option value="fullstack">全栈工程师</option>
                                <option value="go_developer">Go开发工程师</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">公司类型</label>
                            <select class="form-select" id="companyType" required>
                                <option value="">选择公司类型</option>
                                <option value="big_tech">大厂 (BAT, 字节等)</option>
                                <option value="unicorn">独角兽公司</option>
                                <option value="startup">创业公司</option>
                                <option value="traditional">传统企业</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">经验级别</label>
                            <select class="form-select" id="experienceLevel" required>
                                <option value="">选择经验级别</option>
                                <option value="junior">初级 (0-2年)</option>
                                <option value="middle">中级 (2-5年)</option>
                                <option value="senior">高级 (5+年)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">目标面试时间</label>
                            <input type="date" class="form-control" id="interviewDate">
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-rocket me-2"></i>开始制定计划
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>技术栈分布
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="techStackChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 热门题目推荐 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-fire me-2"></i>热门面试题
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success active" data-category="all">全部</button>
                        <button class="btn btn-outline-success" data-category="vue">Vue</button>
                        <button class="btn btn-outline-success" data-category="react">React</button>
                        <button class="btn btn-outline-success" data-category="js">JavaScript</button>
                        <button class="btn btn-outline-success" data-category="golang">Golang</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="hotQuestions" class="row">
                        <!-- 动态加载题目 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 我的面试计划 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>我的面试计划
                    </h5>
                </div>
                <div class="card-body">
                    <div id="myPlans" class="row">
                        <!-- 动态加载面试计划 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    loadPageData();
    initTechStackChart();
    setupEventListeners();
});

function loadPageData() {
    // 加载题目统计
    loadQuestionStats();
    // 加载热门题目
    loadHotQuestions();
    // 加载用户计划
    loadUserPlans();
}

function loadQuestionStats() {
    fetch('/api/questions/by-mode/interview')
        .then(response => response.json())
        .then(data => {
            document.getElementById('questionCount').textContent = data.total || 0;
        })
        .catch(error => {
            console.error('加载题目统计失败:', error);
            document.getElementById('questionCount').textContent = '0';
        });
}

function loadUserPlans() {
    const userId = 1; // 临时硬编码
    fetch(`/api/interview/plans/${userId}`)
        .then(response => response.json())
        .then(plans => {
            document.getElementById('planCount').textContent = plans.length;
            displayPlans(plans);
            
            // 计算总体进度
            if (plans.length > 0) {
                const totalProgress = plans.reduce((sum, plan) => sum + plan.progress_percentage, 0);
                const avgProgress = Math.round(totalProgress / plans.length);
                updateProgressCircle(avgProgress);
            }
        })
        .catch(error => {
            console.error('加载用户计划失败:', error);
        });
}

function displayPlans(plans) {
    const container = document.getElementById('myPlans');
    if (plans.length === 0) {
        container.innerHTML = '<div class="col-12"><p class="text-muted text-center">还没有制定面试计划，快去创建一个吧！</p></div>';
        return;
    }
    
    container.innerHTML = plans.map(plan => `
        <div class="col-md-6 mb-3">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="card-title">${plan.target_position} - ${plan.target_company_type}</h6>
                    <p class="card-text">${plan.target_experience_level} 级别</p>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-success" style="width: ${plan.progress_percentage}%"></div>
                    </div>
                    <small class="text-muted">
                        进度: ${plan.questions_completed}/${plan.total_questions_planned} 题 (${plan.progress_percentage}%)
                    </small>
                    <div class="mt-2">
                        ${plan.focus_technologies.map(tech => `<span class="tech-badge">${tech}</span>`).join('')}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function updateProgressCircle(percentage) {
    const circle = document.getElementById('progressCircle');
    circle.style.setProperty('--progress', percentage + '%');
    circle.querySelector('span').textContent = percentage + '%';
}

// 技术栈图表
function initTechStackChart() {
    const ctx = document.getElementById('techStackChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Vue/前端', 'React', 'JavaScript', 'Golang', '工程化'],
            datasets: [{
                data: [25, 20, 30, 15, 10],
                backgroundColor: [
                    '#28a745',
                    '#17a2b8', 
                    '#ffc107',
                    '#6f42c1',
                    '#fd7e14'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function setupEventListeners() {
    // 面试计划表单提交
    document.getElementById('interviewPlanForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            user_id: 1, // 临时硬编码
            target_position: document.getElementById('targetPosition').value,
            target_company_type: document.getElementById('companyType').value,
            target_experience_level: document.getElementById('experienceLevel').value,
            interview_date: document.getElementById('interviewDate').value
        };
        
        // 提交面试计划
        fetch('/api/interview/plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('面试计划创建成功！');
                // 重新加载计划数据
                loadUserPlans();
                // 重置表单
                this.reset();
            } else {
                alert('创建失败：' + data.error);
            }
        })
        .catch(error => {
            console.error('提交失败:', error);
            alert('提交失败，请稍后重试');
        });
    });

    // 分类切换
    document.querySelectorAll('[data-category]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-category]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            loadHotQuestions(this.dataset.category);
        });
    });
}

// 加载热门题目
function loadHotQuestions(category = 'all') {
    fetch(`/api/interview/hot-questions?category=${category}&limit=6`)
    .then(response => response.json())
    .then(questions => {
        const container = document.getElementById('hotQuestions');
        if (questions.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted text-center">暂无相关题目</p></div>';
            return;
        }
        
        container.innerHTML = questions.map(q => `
            <div class="col-md-6 mb-3">
                <div class="card interview-card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${q.title}</h6>
                        <p class="card-text text-muted">${q.content.substring(0, 100)}...</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-${getDifficultyColor(q.difficulty)}">${getDifficultyText(q.difficulty)}</span>
                            <small class="text-muted">${q.estimated_time}分钟</small>
                        </div>
                        <a href="/interview/practice?question=${q.id}" class="btn btn-sm btn-outline-success mt-2">
                            <i class="fas fa-play me-1"></i>开始练习
                        </a>
                    </div>
                </div>
            </div>
        `).join('');
    })
    .catch(error => {
        console.error('加载热门题目失败:', error);
    });
}

function getDifficultyColor(difficulty) {
    const colors = { easy: 'success', medium: 'warning', hard: 'danger' };
    return colors[difficulty] || 'secondary';
}

function getDifficultyText(difficulty) {
    const texts = { easy: '简单', medium: '中等', hard: '困难' };
    return texts[difficulty] || difficulty;
}
</script>
{% endblock %}
