{% extends "base.html" %}

{% block title %}个性化学习路径{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 左侧用户信息 -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-user-graduate"></i> 学习者档案</h5>
                </div>
                <div class="card-body" id="user-profile">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-target"></i> 学习目标</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">目标难度</label>
                        <select class="form-select" id="targetDifficulty" onchange="updateLearningPath()">
                            <option value="easy">初级 - 基础概念掌握</option>
                            <option value="medium">中级 - 算法应用熟练</option>
                            <option value="hard">高级 - 复杂问题求解</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">学习重点</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="theory" id="focus-theory" onchange="updateLearningPath()">
                            <label class="form-check-label" for="focus-theory">理论基础</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="coding" id="focus-coding" onchange="updateLearningPath()">
                            <label class="form-check-label" for="focus-coding">编程实践</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="multiple_choice" id="focus-choice" onchange="updateLearningPath()">
                            <label class="form-check-label" for="focus-choice">快速测验</label>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm w-100" onclick="generateNewPath()">
                        <i class="fas fa-magic"></i> 重新生成路径
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-route"></i> 个性化学习路径</h4>
                    <div>
                        <button class="btn btn-outline-info btn-sm" onclick="togglePathView()">
                            <i class="fas fa-list" id="view-icon"></i> <span id="view-text">时间线视图</span>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="startLearning()">
                            <i class="fas fa-play"></i> 开始学习
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="learning-path-container" class="scrollable-container">
                        <div class="text-center p-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">正在生成个性化学习路径...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 学习建议 -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-lightbulb"></i> 智能学习建议</h5>
                </div>
                <div class="card-body scrollable-container suggestions-container" id="learning-suggestions">
                    <!-- 建议内容将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 题目详情模态框 -->
<div class="modal fade" id="questionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="questionModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="questionModalBody">
                <!-- 内容将通过JavaScript动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="startQuestion()">开始答题</button>
            </div>
        </div>
    </div>
</div>

<style>
/* 可滑动容器样式 */
.scrollable-container {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 5px;
}

/* 自定义滚动条样式 */
.scrollable-container::-webkit-scrollbar {
    width: 8px;
}

.scrollable-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.scrollable-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.scrollable-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Firefox滚动条样式 */
.scrollable-container {
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f1f1f1;
}

.learning-path-timeline {
    position: relative;
    padding-left: 30px;
}

.learning-path-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #007bff, #28a745);
}

.path-step {
    position: relative;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.path-step:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.path-step::before {
    content: '';
    position: absolute;
    left: -36px;
    top: 25px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #007bff;
    border: 3px solid white;
    box-shadow: 0 0 0 3px #007bff;
}

.path-step.completed::before {
    background: #28a745;
    box-shadow: 0 0 0 3px #28a745;
}

.path-step.current::before {
    background: #ffc107;
    box-shadow: 0 0 0 3px #ffc107;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.knowledge-point-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}

.question-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    transition: all 0.2s ease;
    cursor: pointer;
}

.question-card:hover {
    background: #e9ecef;
    transform: translateY(-2px);
}

.priority-high { border-left-color: #dc3545; }
.priority-medium { border-left-color: #ffc107; }
.priority-low { border-left-color: #28a745; }

.grid-view .path-step {
    margin-bottom: 20px;
    padding: 15px;
}

.grid-view .learning-path-timeline::before {
    display: none;
}

.grid-view .path-step::before {
    display: none;
}

.estimate-time {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.9em;
}

.difficulty-indicator {
    display: inline-flex;
    align-items: center;
    gap: 2px;
}

.difficulty-star {
    color: #ffc107;
    font-size: 0.8em;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .scrollable-container {
        max-height: 500px;
    }
}

@media (max-width: 576px) {
    .scrollable-container {
        max-height: 400px;
    }
}

/* 学习建议容器特殊样式 */
.suggestions-container {
    max-height: 300px;
}

@media (max-width: 768px) {
    .suggestions-container {
        max-height: 250px;
    }
}

@media (max-width: 576px) {
    .suggestions-container {
        max-height: 200px;
    }
}
</style>

<script>
const userId = {{ user_id }};
let learningPathData = [];
let userProfile = {};
let currentView = 'timeline'; // timeline or grid
let currentQuestion = null;

async function loadData() {
    try {
        // 加载用户资料
        const userResponse = await fetch(`/api/users/${userId}`);
        userProfile = await userResponse.json();
        
        // 加载学习路径
        await loadLearningPath();
        
        renderUserProfile();
        renderLearningSuggestions();
        
    } catch (error) {
        console.error('加载数据失败:', error);
        showError('加载数据失败，请刷新页面重试');
    }
}

async function loadLearningPath() {
    try {
        const response = await fetch(`/api/learning-path/${userId}`);
        const data = await response.json();
        learningPathData = data.learning_path || [];
        renderLearningPath();
    } catch (error) {
        console.error('加载学习路径失败:', error);
        showError('加载学习路径失败');
    }
}

function renderUserProfile() {
    const container = document.getElementById('user-profile');
    
    // 设置目标难度选择器的默认值
    document.getElementById('targetDifficulty').value = userProfile.preferred_difficulty;
    
    // 设置学习重点复选框
    const preferredTypes = userProfile.preferred_question_types || [];
    preferredTypes.forEach(type => {
        const checkbox = document.getElementById(`focus-${type.replace('_', '-')}`);
        if (checkbox) checkbox.checked = true;
    });
    
    container.innerHTML = `
        <div class="text-center mb-3">
            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                 style="width: 60px; height: 60px; font-size: 24px;">
                <i class="fas fa-user"></i>
            </div>
        </div>
        
        <h6 class="text-center">${userProfile.username}</h6>
        <p class="text-center text-muted small">${userProfile.email}</p>
        
        <div class="row text-center">
            <div class="col-12 mb-2">
                <span class="badge bg-info">偏好难度: ${getDifficultyText(userProfile.preferred_difficulty)}</span>
            </div>
            <div class="col-12 mb-2">
                <span class="badge bg-secondary">学习模式: ${getInteractionTypeText(userProfile.preferred_interaction_type)}</span>
            </div>
        </div>
        
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> 
                基于您的学习历史和偏好，我们为您定制了专属学习路径
            </small>
        </div>
    `;
}

function renderLearningPath() {
    const container = document.getElementById('learning-path-container');
    
    if (!learningPathData || learningPathData.length === 0) {
        container.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-route fa-3x text-muted mb-3"></i>
                <h5>暂无学习路径</h5>
                <p class="text-muted">系统正在分析您的学习情况，请稍后再试</p>
                <button class="btn btn-primary" onclick="generateNewPath()">
                    <i class="fas fa-magic"></i> 生成学习路径
                </button>
            </div>
        `;
        return;
    }
    
    const timelineClass = currentView === 'timeline' ? 'learning-path-timeline' : '';
    
    const pathHtml = learningPathData.map((path, index) => {
        const priorityClass = `priority-${path.priority}`;
        const isCompleted = false; // 后续可以根据用户完成情况判断
        const isCurrent = index === 0;
        const stepClass = isCompleted ? 'completed' : (isCurrent ? 'current' : '');
        
        return `
            <div class="path-step ${stepClass} ${priorityClass}">
                <div class="knowledge-point-header">
                    <div>
                        <h5 class="mb-1">
                            <i class="fas fa-brain text-primary"></i> 
                            ${path.knowledge_point.name}
                        </h5>
                        <div class="mb-2">
                            <span class="badge bg-secondary">${path.knowledge_point.category}</span>
                            <span class="badge bg-${getPriorityColor(path.priority)}">${getPriorityText(path.priority)}</span>
                            <span class="difficulty-indicator">
                                ${getDifficultyStars(path.knowledge_point.difficulty_level)}
                            </span>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="estimate-time">
                            <i class="fas fa-clock"></i> 约 ${path.estimated_time} 分钟
                        </div>
                    </div>
                </div>
                
                <p class="text-muted mb-3">${path.knowledge_point.description}</p>
                
                <div class="mb-3">
                    <h6>推荐练习题目 (${path.recommended_sequence.length})</h6>
                    <div class="row">
                        ${path.recommended_sequence.map(question => `
                            <div class="col-md-6">
                                <div class="question-card" onclick="showQuestionDetail(${question.id})">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">${question.title}</h6>
                                            <div>
                                                <span class="badge bg-primary">${getQuestionTypeText(question.question_type)}</span>
                                                <span class="badge bg-${getDifficultyColor(question.difficulty)}">${question.difficulty}</span>
                                                ${question.estimated_time ? `<span class="badge bg-info">${question.estimated_time}min</span>` : ''}
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-target"></i> 
                        通过练习提升在 ${path.knowledge_point.name} 方面的掌握程度
                    </small>
                    <button class="btn btn-primary btn-sm" onclick="startKnowledgePointPractice(${path.knowledge_point.id})">
                        <i class="fas fa-play"></i> 开始学习
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `<div class="${timelineClass}">${pathHtml}</div>`;
}

function renderLearningSuggestions() {
    const container = document.getElementById('learning-suggestions');
    
    // 基于用户数据生成个性化建议
    const suggestions = generateSuggestions();
    
    container.innerHTML = suggestions.map(suggestion => `
        <div class="alert alert-${suggestion.type} d-flex align-items-center" role="alert">
            <i class="fas fa-${suggestion.icon} me-2"></i>
            <div>
                <strong>${suggestion.title}</strong><br>
                <small>${suggestion.content}</small>
            </div>
        </div>
    `).join('');
}

function generateSuggestions() {
    const suggestions = [];
    
    // 基于偏好难度给出建议
    if (userProfile.preferred_difficulty === 'easy') {
        suggestions.push({
            type: 'info',
            icon: 'lightbulb',
            title: '循序渐进',
            content: '建议先掌握基础概念，每天练习20-30分钟，重点关注理论理解。'
        });
    } else if (userProfile.preferred_difficulty === 'hard') {
        suggestions.push({
            type: 'warning',
            icon: 'fire',
            title: '挑战模式',
            content: '可以尝试更复杂的算法题，建议每天练习45-60分钟，注重代码实现。'
        });
    }
    
    // 学习路径相关建议
    if (learningPathData.length > 0) {
        suggestions.push({
            type: 'success',
            icon: 'check-circle',
            title: '个性化路径已就绪',
            content: `为您推荐了 ${learningPathData.length} 个重点学习方向，预计总学习时间 ${learningPathData.reduce((sum, path) => sum + path.estimated_time, 0)} 分钟。`
        });
    }
    
    // 通用学习建议
    suggestions.push({
        type: 'info',
        icon: 'clock',
        title: '学习节奏建议',
        content: '建议保持规律的学习节奏，每次学习后及时复习，遇到困难可以先学习相关基础知识。'
    });
    
    return suggestions;
}

async function showQuestionDetail(questionId) {
    try {
        const response = await fetch(`/api/questions/${questionId}`);
        currentQuestion = await response.json();
        
        document.getElementById('questionModalTitle').innerHTML = `
            <i class="fas fa-question-circle"></i> ${currentQuestion.title}
            <span class="badge bg-${getDifficultyColor(currentQuestion.difficulty)} ms-2">${currentQuestion.difficulty}</span>
        `;
        
        let contentHtml = `
            <div class="mb-3">
                <h6>题目内容</h6>
                <p>${currentQuestion.content}</p>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6>基本信息</h6>
                    <ul class="list-unstyled">
                        <li><strong>类型:</strong> ${getQuestionTypeText(currentQuestion.question_type)}</li>
                        <li><strong>难度:</strong> ${currentQuestion.difficulty}</li>
                        <li><strong>预计时间:</strong> ${currentQuestion.estimated_time || '未设定'} 分钟</li>
                        <li><strong>知识点:</strong> ${currentQuestion.knowledge_point ? currentQuestion.knowledge_point.name : '未分类'}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>学习价值</h6>
                    <p class="text-muted">${currentQuestion.explanation || '通过这道题目可以加深对相关知识点的理解。'}</p>
                </div>
            </div>
        `;
        
        // 如果是选择题，显示选项
        if (currentQuestion.question_type === 'multiple_choice' && currentQuestion.options) {
            contentHtml += `
                <div class="mb-3">
                    <h6>选项</h6>
                    <div class="list-group">
                        ${currentQuestion.options.map(option => `
                            <div class="list-group-item">${option}</div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // 如果是编程题，显示初始代码
        if (currentQuestion.question_type === 'coding' && currentQuestion.starter_code) {
            contentHtml += `
                <div class="mb-3">
                    <h6>初始代码模板</h6>
                    <pre class="bg-light p-3 rounded"><code>${currentQuestion.starter_code}</code></pre>
                </div>
            `;
        }
        
        document.getElementById('questionModalBody').innerHTML = contentHtml;
        new bootstrap.Modal(document.getElementById('questionModal')).show();
        
    } catch (error) {
        console.error('加载题目详情失败:', error);
        showError('加载题目详情失败');
    }
}

function togglePathView() {
    currentView = currentView === 'timeline' ? 'grid' : 'timeline';
    
    const viewIcon = document.getElementById('view-icon');
    const viewText = document.getElementById('view-text');
    
    if (currentView === 'timeline') {
        viewIcon.className = 'fas fa-list';
        viewText.textContent = '时间线视图';
    } else {
        viewIcon.className = 'fas fa-th-large';
        viewText.textContent = '网格视图';
    }
    
    renderLearningPath();
}

function updateLearningPath() {
    // 实际应用中，这里应该调用API根据新的偏好重新生成学习路径
    generateNewPath();
}

async function generateNewPath() {
    const container = document.getElementById('learning-path-container');
    container.innerHTML = `
        <div class="text-center p-4">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">正在重新生成学习路径...</p>
        </div>
    `;
    
    // 模拟重新生成过程
    setTimeout(async () => {
        await loadLearningPath();
        renderLearningSuggestions();
    }, 2000);
}

function startLearning() {
    if (learningPathData.length > 0) {
        const firstPath = learningPathData[0];
        startKnowledgePointPractice(firstPath.knowledge_point.id);
    }
}

function startKnowledgePointPractice(knowledgePointId) {
    window.location.href = `/practice/${userId}?knowledge_point=${knowledgePointId}`;
}

function startQuestion() {
    if (currentQuestion) {
        window.location.href = `/practice/${userId}?question=${currentQuestion.id}`;
    }
}

// 工具函数
function getDifficultyText(difficulty) {
    const map = { 'easy': '初级', 'medium': '中级', 'hard': '高级' };
    return map[difficulty] || difficulty;
}

function getInteractionTypeText(type) {
    const map = { 'theory': '理论学习', 'practice': '实践练习', 'mixed': '混合模式' };
    return map[type] || type;
}

function getPriorityText(priority) {
    const map = { 'high': '高优先级', 'medium': '中等优先级', 'low': '低优先级' };
    return map[priority] || priority;
}

function getPriorityColor(priority) {
    const map = { 'high': 'danger', 'medium': 'warning', 'low': 'success' };
    return map[priority] || 'secondary';
}

function getDifficultyStars(level) {
    const stars = [];
    for (let i = 1; i <= 5; i++) {
        stars.push(`<span class="difficulty-star">${i <= level ? '★' : '☆'}</span>`);
    }
    return stars.join('');
}

function getDifficultyColor(difficulty) {
    const map = { 'easy': 'success', 'medium': 'warning', 'hard': 'danger' };
    return map[difficulty] || 'secondary';
}

function getQuestionTypeText(type) {
    const map = {
        'theory': '理论题',
        'multiple_choice': '选择题',
        'coding': '编程题',
        'practical': '实践题'
    };
    return map[type] || type;
}

function showError(message) {
    const container = document.getElementById('learning-path-container');
    container.innerHTML = `
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', loadData);
</script>
{% endblock %}
